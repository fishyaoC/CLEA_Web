@using Clea_Web.Models;
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model Clea_Web.ViewModels.IntroViewModel.Env;
@{
    Layout = "~/Views/Shared/_LayoutBackEnd.cshtml";
    dbContext db = new dbContext();
}

<div class="content-wrapper">
    <form class="form-sample" method="post" action="@Url.Action("EnvModify","B_Intro")" enctype='multipart/form-data'>
        <div class="mb-2 mt-2">
            <button type="submit" class="btn btn-info">儲存</button>
            @* <button type="button" class="btn btn-secondary">取消</button> *@
            <a href="@Url.Action("EnvIndex","B_Intro")" class="btn btn-secondary">取消</a>
        </div>
        <div class="row">
            <div class="col-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            環境介紹管理 - @(Model.IsEdit ? "編輯" : "新增")
                        </h4>
                        @Html.AntiForgeryToken()
                        @*回傳狀態*@
                        @Html.HiddenFor(x => x.IsEdit)
                        @*回傳Uid*@
                        @Html.HiddenFor(x => x.Uid)
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    @Html.LabelFor(x => x.Title, new { @class = "col-sm-3 col-form-label" })
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(x => x.Title, new { @class = "form-control form-control", placeholder = "標題" })
                                        @Html.ValidationMessageFor(x=>x.Title)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    @Html.LabelFor(x => x.Memo, new { @class = "col-sm-3 col-form-label" })
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(x => x.Memo, new { @class = "form-control form-control", placeholder = "相簿說明" })
                                        @Html.ValidationMessageFor(x=>x.Memo)
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group row">
                                    @Html.LabelFor(x => x.Order, new { @class = "col-sm-3 col-form-label" })
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(x => x.Order, new { @class = "form-control form-control", placeholder = "相簿排序" })
                                        @Html.ValidationMessageFor(x=>x.Order)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label">是否上架</label>
                                    <div class="col-sm-9 d-flex justify-content-around">
                                        <div class="form-check">
                                            @Html.RadioButtonFor(x => x.Status, true, new { @class = "form-check-input", @name = "Status" })
                                            <label for="TypeY">
                                                是
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            @Html.RadioButtonFor(x => x.Status, false, new {@class = "form-check-input", @name = "Status" })
                                            <label for="TypeN">
                                                否
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 grid-margin stretch-card">
                                <div class="card" style="background-color:#E0E0E0; border-radius:7px">
                                    <h4 class="card-title">
                                        相片上傳
                                    </h4>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group row">
                                                    <label for="exampleInputName" class="col-sm-3 col-form-label">上傳檔案</label>
                                                    <div class="col-sm-9">
                                                        @Html.TextBoxFor(x => x.file, new { @class="form-control", placeholder = "上傳檔案", @type = "file", id = "fileUpload", multiple = "multiple", onchange = "displayUploadedFiles(this)", accept = "image/*" })
                                                        @Html.ValidationMessageFor(x => x.file)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="table-responsive">
                                                <table class="table" style="border-radius:7px">
                                                    <thead>
                                                        <tr>
                                                            <th>序</th>
                                                            <th>縮圖預覽</th>
                                                            <th>圖片說明</th>
                                                            <th>是否為首圖</th>
                                                            <th>操作</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="imageList">
                                                        @if (Model.IMGList != null)
                                                        {
                                                            Int32 rowCount = 0;
                                                            foreach (var item in Model.IMGList)
                                                            {
                                                                rowCount++;
                                                                <tr>
                                                                    @Html.HiddenFor(x=>x.IMGList[rowCount-1].Uid)
                                                                    <td>@rowCount</td>
                                                                    <td><img id="imagePreview_@rowCount" style="width: 100px; height: 100px; border-radius: 5px;" src="data:image/jpeg;base64,@item.IMG" /></td>
                                                                    <td>@Html.TextBoxFor(x => x.IMGList[rowCount-1].Memo, new { @class = "form-control form-control", placeholder = "圖片說明" })</td>
                                                                    <td>
                                                                        @Html.RadioButtonFor(x => x.IMGList[rowCount-1].thum, true, new { @class = "thum-radio", data_rowcount = rowCount })
                                                                    </td>
                                                                    <td>
                                                                        <button type="button" class="btn btn-danger" onclick="del('@item.Uid')">刪除</button>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <tr>
                                                                <td colspan="7" align="center">查無資料!</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
    // 添加事件监听器以捕获文件上传事件
    document.getElementById('fileUpload').addEventListener('change', function (event) {
        var files = event.target.files;
        var imageList = document.getElementById('imageList');

        if (files.length > 0) {
            for (var i = 0; i < files.length; i++) {
                var file = files[i];
                var reader = new FileReader(); // 创建FileReader对象

                reader.onload = (function (file) {
                    return function (event) {
                        var rowCount = imageList.rows.length +1 ;
                        var imageData = event.target.result; // 获取文件的Base64编码字符串

                        var newRow = imageList.insertRow();
                        var cell1 = newRow.insertCell(0);
                        var cell2 = newRow.insertCell(1);
                        var cell3 = newRow.insertCell(2);
                        var cell4 = newRow.insertCell(3);
                        var cell5 = newRow.insertCell(4);

                        cell1.innerHTML = rowCount;
                        cell2.innerHTML = '<img style="width: 100px; height: 100px; border-radius: 5px;" src="' + imageData + '" />';
                        cell3.innerHTML = '<input class="form-control form-control" type="text" placeholder="圖片說明" name="IMGList[' + (rowCount - 1) + '].Memo" />';
                        cell4.innerHTML = '<input class="thum-radio" type="radio" name="IMGList[' + (rowCount - 1) + '].thum" />';
                        //cell5.innerHTML = '<button type="button" class="btn btn-danger" onclick="del(' + rowCount + ')">刪除</button>';

                        $('.thum-radio').change(function () {
                            $('.thum-radio').prop('checked', false);
                            $(this).prop('checked', true);
                        });
                    };
                })(file);

                // 读取文件为DataURL
                reader.readAsDataURL(file);
            }
        }
    });

    function del(rowCount) {
        //刪除按紐
        Swal.fire({
            title: '是否確定要刪除檔案？',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '是',
            cancelButtonText: '否',
            heightAuto: false
        }).then((result) => {
            if (!result.isConfirmed) {
                return;
            }
            else {
                // 删除对应的行
                $('#imageList tr:eq(' + rowCount + ')').remove();
            }
        });
    }
</script>
